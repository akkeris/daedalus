const {formatBytes} = require('../../../common/format.js');
module.exports = (req, res, next, data) => res.send(`
  ${require('./header.html')(req)}
    <appkit-app>
      ${require('./object-header.html')(req, data, 'Databases', 'fa-database', `/ui/postgresql/databases/${data.database}`, data.database, 'databases')}
      <div>
        <h2>${data.name}</h2>
        <dl class="facts">
          ${data.config && data.config.server_version && data.config.server_version.value ? `
          <dt>Version</dt>
          <dd>${data.config.server_version.value}</dd>` : ''}
          <dt>Size</dt>
          <dd>
            ${formatBytes(data.tableStatistics.reduce((acc, x) => 
              (x.index_size + x.table_size + acc), 0))}
          </dd>
          <dt>Data Size</dt>
          <dd>${formatBytes(data.tableStatistics.reduce((acc, x) => (x.table_size + acc), 0))}</dd>
          <dt>Connections</dt>
          <dd>${data.databaseStatistics[0] ? 
            data.databaseStatistics[0].used_connections : 0}/${data.databaseStatistics[0] ? 
              data.databaseStatistics[0].max_connections : 0}</dd>
          <dt>Scanned</dt>
          <dd>${new Date(data.observed_on).toLocaleString()}</dd>
        </dl>
      </div>
      <x-tabs>
        <x-tab><a href="#metadata">Metadata</a></x-tab>
        <x-tab><a href="#changes">Changes</a></x-tab>
        <x-tab><a href="#used_by">Used By</a></x-tab>
        <x-tab><a href="#tables">Tables</a></x-tab>
        <x-tab><a href="#roles">Roles</a></x-tab>
        <x-tab><a href="#settings">Settings</a></x-tab>
      </x-tabs>
      <div name="metadata" class="tab-panel list">
        ${require('./labels.html')(req, data, `/ui/postgresql/databases/${data.database}`)}
        ${require('./annotations.html')(req, data, `/ui/postgresql/databases/${data.database}`)}
      </div>
      <div name="changes" class="tab-panel list">
        ${require('./changes.html')(req, data)}
      </div>
      <div name="used_by" class="list tab-panel"> 
        ${require('./used_by.html')(req, data)}
      </div>
      <div name="tables" class="list tab-panel">
        ${data.tables.filter((x) => !x.is_view).map((table) => `
        <div class="list-item">
          <div>${table.schema}.${table.name}</div>
          <div>${data.tableStatistics.filter((x) => x.table === table.table).map((ts) => `
            <dl class="facts">
              <dt>Rows</dt><dd>${ts.row_amount_estimate}</dd>
              <dt>Size</dt><dd>${formatBytes(ts.table_size + ts.index_size)}</dd>
              <dt>Stats</dt>
              <dd>
                <a href="#" class="info-button info-button-${table.schema}-${table.name}">
                  <i class="fa fa-info-circle" aria-hidden="true"></i>
                </a>
                <x-dropdown class="right" target=".info-button-${table.schema}-${table.name}">
                  <nav>
                    <ul class="facts">
                      <li>Scans • ${ts.sequential_scans}</li>
                      <li>Index Used • ${(ts.percent_of_times_index_used * 100).toFixed(2)}%</li>
                      <li>Index Hit Rate  • ${(ts.index_hit_rate * 100).toFixed(2)}%</li>
                      <li>Table (Heap) Hit Rate • ${(ts.table_hit_rate * 100).toFixed(2)}%</li>
                    </ul>
                  </nav>
                </x-dropdown>
              </dd> `)}
          </div>
        </div>
        `).join("")}
      </div> 
      <div name="roles" class="tab-panel list"> ${data.roles.map((role) => `
        <div class="list-item">
          <div><i class="fa fa-user" aria-hidden="true"></i> ${role.username}</div>
          <div>postgres://${role.username}@${data.host}:${data.port}/${data.name}</div>
        </div> `).join("")}
      </div>
      <div name="settings" class="tab-panel list"> ${Object.keys(data.config).map((key) => `
        <div class="list-item">
          <div><pre class="inline half"><code class="nohighlight">${key}=${data.config[key].value}</code></pre></div>
          <div>${data.config[key].description}</div>
        </div> `).join("")}
      </div>
    </appkit-app>
  ${require('./footer.html')(req, res)}
`);